<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">

<link rel="import" href="event-fire-dialog.html">
<link rel="import" href="service-call-dialog.html">
<link rel="import" href="state-set-dialog.html">

<polymer-element name="home-assistant-api" attributes="auth">
  <template>
    <paper-toast id="toast" role="alert" text=""></paper-toast>
    <event-fire-dialog id="eventDialog" api={{api}}></event-fire-dialog>
    <service-call-dialog id="serviceDialog" api={{api}}></service-call-dialog>
    <state-set-dialog id="stateDialog" api={{api}}></state-set-dialog>
  </template>
  <script>

  State = function(json, api) {
      this.api = api;

      this.attributes = json.attributes;

      this.entity_id = json.entity_id;
      var parts = json.entity_id.split(".");
      this.domain = parts[0];
      this.entity = parts[1];

      if(this.attributes.friendly_name) {
        this.entityDisplay = this.attributes.friendly_name;
      } else {
        this.entityDisplay = this.entity.replace(/_/g, " ");
      }

      this.state = json.state;
      this.last_changed = json.last_changed;
  };

  Object.defineProperties(State.prototype, {
    "stateDisplay": {
      get: function() {
        var state = this.state.replace(/_/g, " ");
        if(this.attributes.unit_of_measurement) {
          return state + " " + this.attributes.unit_of_measurement;
        } else {
          return state;
        }
      }
    },

    "isCustomGroup": {
      get: function() {
        return this.domain == "group" && !this.attributes.auto;
      }
    },

    "canToggle": {
      get: function() {
        // groups that have the on/off state or if there is a turn_on service
        return ((this.domain == 'group' &&
                 (this.state == 'on' || this.state == 'off')) ||
                this.api.hasService(this.domain, 'turn_on'));
      }
    }
  });

  Polymer({
    auth: "not-set",
    states: [],
    services: [],
    events: [],
    stateUpdateTimeout: null,

    created: function() {
      this.api = this;

      // so we can pass these methods safely as callbacks
      this.turn_on = this.turn_on.bind(this);
      this.turn_off = this.turn_off.bind(this);
    },

    // local methods
    getState: function(entityId) {
      var found = this.states.filter(function(state) {
        return state.entity_id == entityId;
      }, this);

      return found.length > 0 ? found[0] : null;
    },

    hasService: function(domain, service) {
      var found = this.services.filter(function(serv) {
        return serv.domain == domain && serv.services.indexOf(service) !== -1;
      }, this);

      return found.length > 0;
    },

    _laterFetchStates: function() {
      if(this.stateUpdateTimeout) {
        clearTimeout(this.stateUpdateTimeout);
      }

      // update states in 60 seconds
      this.stateUpdateTimeout = setTimeout(this.fetchStates.bind(this), 60000);
    },

    _sortStates: function(states) {
      states.sort(function(one, two) {
        if (one.entity_id > two.entity_id) {
          return 1;
        } else if (one.entity_id < two.entity_id) {
          return -1;
        } else {
          return 0;
        }
      });
    },

    _pushNewState: function(new_state) {
      var state;
      var stateFound = false;

      for(var i = 0; i < this.states.length; i++) {
        if(this.states[i].entity_id == new_state.entity_id) {
          state = this.states[i];
          state.attributes = new_state.attributes;
          state.last_changed = new_state.last_changed;
          state.state = new_state.state;

          stateFound = true;
          break;
        }
      }

      if(!stateFound) {
        this.states.push(new State(new_state, this));
        this._sortStates(this.states);
      }

      this.fire('states-updated');
    },

    _pushNewStates: function(new_states) {
      new_states.map(function(state) {
        this._pushNewState(state);
      }.bind(this));
    },

    // call api methods
    fetchAll: function() {
      this.fetchStates();
      this.fetchServices();
      this.fetchEvents();
    },

    fetchState: function(entityId) {
      var successStateUpdate = function(new_state) {
        this._pushNewState(new_state);
      };

      this.call_api("GET", "states/" + entityId, null, successStateUpdate.bind(this));
    },

    fetchStates: function(onSuccess, onError) {
      var successStatesUpdate = function(newStates) {
        this._sortStates(newStates);

        this.states = newStates.map(function(json) {
          return new State(json, this);
        }.bind(this));

        this.fire('states-updated');

        this._laterFetchStates();

        if(onSuccess) {
          onSuccess(this.states);
        }
      };

      this.call_api(
        "GET", "states", null, successStatesUpdate.bind(this), onError);
    },

    fetchEvents: function(onSuccess, onError) {
      var successEventsUpdated = function(events) {
        this.events = events;

        this.fire('events-updated');

        if(onSuccess) {
          onSuccess(events);
        }
      };

      this.call_api(
        "GET", "events", null, successEventsUpdated.bind(this), onError);
    },

    fetchServices: function(onSuccess, onError) {
      var successServicesUpdated = function(services) {
        this.services = services;

        this.fire('services-updated');

        if(onSuccess) {
          onSuccess(this.services);
        }
      };

      this.call_api(
        "GET", "services", null, successServicesUpdated.bind(this), onError);
    },

    turn_on: function(entity_id, options) {
      this.call_service(
        "homeassistant", "turn_on", {entity_id: entity_id}, options);
    },

    turn_off: function(entity_id, options) {
      this.call_service(
        "homeassistant", "turn_off", {entity_id: entity_id}, options);
    },

    set_state: function(entity_id, state, attributes) {
      var payload = {state: state};

      if(attributes) {
        payload.attributes = attributes;
      }

      var successToast = function(new_state) {
        this.showToast("State of "+entity_id+" set to "+state+".");
        this._pushNewState(new_state);
      };

      this.call_api("POST", "states/" + entity_id,
                    payload, successToast.bind(this));
    },

    call_service: function(domain, service, parameters, options) {
      parameters = parameters || {};
      options = options || {};

      var successHandler = function(changed_states) {
        if(service == "turn_on" && parameters.entity_id) {
          this.showToast("Turned on " + parameters.entity_id + '.');
        } else if(service == "turn_off" && parameters.entity_id) {
          this.showToast("Turned off " + parameters.entity_id + '.');
        } else {
          this.showToast("Service "+domain+"/"+service+" called.");  
        }

        this._pushNewStates(changed_states);

        if(options.success) {
          options.success();
        }
      };

      var errorHandler = function(error_data) {
        if(options.error) {
          options.error(error_data);
        }
      };

      this.call_api("POST", "services/" + domain + "/" + service,
                    parameters, successHandler.bind(this), errorHandler);
    },

    fire_event: function(eventType, eventData) {
      eventData = eventData || {};

      var successToast = function() {
        this.showToast("Event "+eventType+" fired.");
      };

      this.call_api("POST", "events/" + eventType,
                    eventData, successToast.bind(this));
    },

    call_api: function(method, path, parameters, onSuccess, onError) {
      var url = "/api/" + path;

      // set to true to generate a frontend to be used as demo on the website
      if (false) {
        if (path === "states" || path === "services" || path === "events") {
          url = "/demo/" + path + ".json";
        } else {
          return;
        }
      }
      var req = new XMLHttpRequest();
      req.open(method, url, true);
      req.setRequestHeader("X-HA-access", this.auth);

      req.onreadystatechange = function() {

        if(req.readyState == 4) {
          if(req.status > 199 && req.status < 300) {
            if(onSuccess) {
              onSuccess(JSON.parse(req.responseText));
            }
          } else {
            if(onError) {
              var data = req.responseText ? JSON.parse(req.responseText) : {};
              onError(data);
            }
          }


        }
      }.bind(this);

      if(parameters) {
        req.send(JSON.stringify(parameters));
      } else {
        req.send();
      }
    },

    // show dialogs
    showEditStateDialog: function(entityId) {
      var state = this.getState(entityId);

      this.showSetStateDialog(entityId, state.state, state.attributes);
    },

    showSetStateDialog: function(entityId, state, stateAttributes) {
      entityId = entityId || "";
      state = state || "";
      stateAttributes = stateAttributes || null;

      this.$.stateDialog.show(entityId, state, stateAttributes);
    },

    showFireEventDialog: function(eventType, eventData) {
      eventType = eventType || "";
      eventData = eventData || "";

      this.$.eventDialog.show(eventType, eventData);
    },

    showCallServiceDialog: function(domain, service, serviceData) {
      domain = domain || "";
      service = service || "";
      serviceData = serviceData || "";

      this.$.serviceDialog.show(domain, service, serviceData);
    },

    showToast: function(message) {
      this.$.toast.text = message;
      this.$.toast.show();
    },

    logOut: function() {
      this.auth = "";
    }

  });
  </script>
</polymer-element>
